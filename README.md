# LDO-Voltage-Regulator-with-Frequency-Compensation
The purpose of this Hackathon is to implement the proposed design in 28 nm PDK (Process Design Kit).

 As a result of literature survey and Implemantation, this is a final Report Submission for successful completion of LDO-Voltage-Regulator-with-Frequency-Compensation design and simulation, for [Cloud Based Analog IC Design Hackathon](https://www.iith.ac.in/events/2022/02/15/Cloud-Based-Analog-IC-Design-Hackathon/)

## Table of Contents
1. [Introduction](#introduction)
2. [Problem with Typical LDO voltage regulator](#Problem-with-Typical-LDO-voltage-regulator)
3. [Capacitive Feedback for Frequency Compensation](#Capacitive-Feedback-for-Frequency-Compensation)
4. [Design Considerations for the VCCS](#Design-Considerations-for-the-VCCS)
5. [Error Amplifier](#Error-Amplifier)
6. [Pass Transistor](#Pass-Transistor)
7. [Working](#working)
8. [Reference Circuit](#reference-circuit)
9. [Implementation](#implementation)
10. [Schematic Netlist](#schematic-netlist)
11. [Simulation result](#simulation-result)
12. [Challenge](#challenge)
13. [Troubleshooting](#troubleshooting)
14. [Limitations](#limitations)
15. [References](#references)
16. [Acknowledgements](#acknowledgements)
17. [Author](#author)

## Introduction

POWER management is a very important issue in portable  electronic applications. The need for  multiple  on-chip voltage levels makes voltage regulators a critical part of an electronic system design. Portable electronic devices like cell phones require very efficient power management to increase the battery life whereas high-speed microprocessors need stable voltages that can supply fast varying currents on the order of few amperes.

The choice of a voltage regulator for a given application offers numerous design tradeoff considerations.The emphasis on efficiency has made low dropout (LDO) regulators the most popular class of linear regulators. But this increase in efficiency is achieved at the cost of a compromise in stability of the regulator. LDO regulators have high output impedance; this impedance, along with the load capacitance, creates a low frequency pole and decreases the overall phase margin.

This design gives an overview of stability problems in LDO voltage regulators and presents a modified LDO voltage regulator topology. Although the compensating circuit is very simple, the proposed topology successfully overcomes the problem of stability without significantly increasing the power consumption or die area.


## Problem-with-Typical-LDO-voltage-regulator

![image](https://user-images.githubusercontent.com/20799294/155582127-fcf582cd-5070-435d-a4b7-a5d2079b0fc8.png)


## Capacitive-Feedback-for-Frequency-Compensation

The basic idea behind the capacitive feedback which is responsible for frequency compensation is to introduce a left hand plane zero in the feedback loop that would replace the zero generated by ESR of the output capacitor. The proposed method starts with the addition of a pole–zero pair and proceeds toward eliminating the pole from the pole–zero pair.

The capacitor  is split into two frequency-dependent voltage-controlled current sources (VCCS) and grounded capacitors. The capacitor C1 and  the VCCS connected to vout do not significantly  alter  the voltage at that node since  CL is of severa l microfarads, whereas  C1  is on the order of few picofarads. It should also be noted that the  capacitor connected to vx is responsible for the additional pole Wp3; therefore it is eliminated to arrive to the final configuration of Fig. 1. This configuration generates the required zero; the LDO becomes a  two-loop  system. The VCCS is  a differentiator that increases the loop gain at high frequencies. The loop gain transfer function of the regulator with this configuration has one zero and two poles.

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155711189-ea65db89-bfe8-4918-9830-8b7f14f0f53a.png" alt="LDO voltage regulator topology with proposed frequency compensation"> 
	<h5 align="center">Figure 2: LDO voltage regulator topology with proposed frequency compensation</h5>
</p>

## Design-Considerations-for-the-VCCS

The transistor-level design challenge lies in realizing the frequency dependent VCCS with minimum die area and minimum power consumption while retaining the VCCS characteristics up to crossover  frequency of the loop  transfer function. The  simplest  realization of  this  circuit  and  transconductance gain enhanced structure is shown in Fig. 2(a) and 2(b) respectively.The bias current can be selected to meet the objective of minimal standby current; the limit is however determined by the frequency of its parasitic pole.

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155713863-b5b07387-6fbf-489c-8b5f-af0f3b091978.png" alt="LDO voltage regulator topology with proposed frequency compensation"> 
	<h5 align="center">Figure 2: Simplest realization of frequency dependent VCCS. (a) Simplest realization and (b) transconductance gain enhanced structure.</h5>
</p>

We need to improve the effective transconductance by increasing the bias current drastically increases the power consumption ( scales proportional to the square root of bias current). Therefore, alternate Gm enhancement techniques should be explored.
The transistor realization is shown in Fig. 3. The circuit consists of three parts. The first stage acts as a level-shifting buffer needed to down-shift the dc level which can be very close to  the  supply  voltage due to LDO characteristics of the regulator. The next stage is with enhancing OTA in feedback. The third stage consists of a 1:5 current mirror and bias sources that together perform  the  function of pumping the ac current through output. We can take advantage of a multiplication factor in the current mirror to increase the effective capacitance from 5 to 25 pF. Cascode current mirror and cascode bias current sources (bias by proper dc voltages and ) are used such that offset current is not significant enough to upset the dc output voltage of the regulator.

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155715916-4db711cd-1797-46e6-8a12-5e8218ad71c9.png" alt="Transistor level implementation of VCCS with G enhancement"> 
	<h5 align="center">Figure 3: Transistor level implementation of VCCS with Gm enhancement.</h5>
</p>

## Error-Amplifier

The error amplifier design demands careful attention to meet the required loop gain, transient response and stability. 
Ideal requirements of the error amplifier are: 1) high dc gain to ensure high loop gain (typically) for all loads; 
					       2) low output impedance to keep the pole at the input of the pass transistor at high frequencies; 
					       3) positive rail output to turn offpass transistor when the load turns off; and 
					       4) internal poles at significantly higher frequencies compared to the cross over loop frequency.
High output impedance of the error amplifier pushes the pole at the input of the pass transistor Wp2 to lower frequencies. Wp2 is pushed to higher frequencies by limiting the output impedance of the error amplifier; hence the use of a two-stage error amplifier is a must.

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155718678-27dd0311-fc2b-4674-9ede-64ff72bd6c04.png" alt="Transistor level implementation of amplifier"> 
	<h5 align="center">Figure 4: Transistor level implementation of error amplifier.</h5>
</p>

## Pass-Transistor

The important design consideration for the pass transistor is the dropout voltage. Increasing the size of the pass transistor lowers the dropout voltage for a particular output current, but wider pass transistor introduces higher input capacitance making it difficult to meet stability and slew rate requirements. The design presented uses a pass transistor of W/L ratio of 6000 that gives a maximum output current of 100 mA with a dropout voltage of 0.5 V. Minimum length is not used as it makes the transistor output impedance unacceptably low at high load currents

## Working

This circuit is a Latch based Integrated Clock gating cell (ICG), which produces a clock pulse only whenever a high enable signal is encountered. 2 Transmission gates (2 PMOS, 2 NMOS), 3 Inverters (3 PMOS, 3 NMOS) and 1 AND gate (3 PMOS, 3 NMOS), are used to construct this circuit. To implement negative Dlatch, Transmission gates logic is used. Simply this circuit comprise of negative Dlatch and And gate.
Here when CLK is 0, Enable is (0,1), g1 is ON and output from g1 is (1,0), g2 passes (1,0), output from g4 is (0,1), output of g5 is (1,0), g3 is OFF and will not allow any signal to pass through it, output of g6 is 0 (i.e., ICG_CLK = 0), now when CLK is 1, Enable is (0,1), g1 is OFF and will not allow any signal to pass through it, now g3 is ON now it will pass previously store inverted value, now the output from g4 is non-inverted value now output of g6 is inverted value (i.e., ICG_CLK = Enable)

<p align="center">
	<img width="400" src="Images/Dlatch.png" alt="Negetive level sensitive latch"> 
	<h5 align="center">Figure 1: Latch based ICG</h5>
</p>

In summary when CLK = 0, Dlatch is enabled hence output from Dlatch will change as per enable signal, due to AND gate, the output of ICG = 0 as one of input of AND is 0, When CLK = 1, Dlatch is disabled hence output will be of previous stored value as one of input of AND is 1.
This circuit arrangement is also min pulse width violation free as compared to only AND based clock gating. Latch based clock gating passes one complete cycle of clock whenever the enable signal is High and stops cycle for which enable signal is low.


## Reference Circuit

<p align="center">
	<img width="600" src="Images/ref_ICG_sch.png" alt="refference ICG Schematic"> 
	<h5 align="center">Figure 2: Gate level schematic</h5>
</p>

<p align="center">
	<img width="1500" src="Images/ref_ICG_trans.png" alt="refference ICG Trans"> 
	<h5 align="center">Figure 3: Transistor level schematic</h5>
	</p>

## Implementation 

### Schematic of LDO voltage regulator topology with proposed frequency compensation.

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155721410-34830e30-5fda-4fbd-8e00-908608cd165a.png" alt="Transistor level implementation of amplifier"> 
	<h5 align="center">Figure 5: Schematic of LDO voltage regulator topology with proposed frequency compensation.</h5>
</p>

### Schematic and symbol of Voltage controlled current source (VCCS) .

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155722237-004e5786-a87b-48bf-b52d-f80b4eec59a2.png" alt="Schematic of Voltage controlled current source (VCCS)"> 
	<h5 align="center">Figure 6: Schematic of Voltage controlled current source (VCCS).</h5>
</p>

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155722514-82b5f99a-9c02-41bb-a9bc-f388c28d461e.png" alt="Symbol of Voltage controlled current source (VCCS)"> 
	<h5 align="center">Figure 7: Symbol of Voltage controlled current source (VCCS).</h5>
</p>

### Schematic and symbol of Error Amplifier .

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155723177-adb88f20-6183-4933-9e7f-6b8a3bc6e58c.png" alt="Schematic of Error Amplifier"> 
	<h5 align="center">Figure 8: Schematic of Error Amplifier.</h5>
</p>

<p align="center">
	<img width="500" src="https://user-images.githubusercontent.com/20799294/155723188-614880f0-df92-44fb-bd89-6f25390d0b9b.png" alt="Symbol of Error Amplifier"> 
	<h5 align="center">Figure 9: Symbol of Error Amplifier.</h5>
</p>





- Integrated clock gating is implemented by using Inverter, AND and Transmission gate.
- The Aspect ratio of pMOS and nMOS is choosen such a way that it has approximate same transaction and fall time (i.e., The Aspect ratio(W/L) of pMOS is 0.03um/0.24um &  nMOS is 0.03um/0.12um).
- Inverter, AND and Transmission gate are implemeted first then by the help of these sub-design ICG is realised.
- Total transistors used = 18 (9 nMOS & 9 pMOS).
- The MOSFET model chosen is TT model from 28nm PDK.

<p align="center">
	<img width="1500" src="Images/ICG.png" alt="Integrated Clock Gating schematic"> 
	<h5 align="center">Figure 4: Integrated Clock Gating schematic</h5>
	<img width="1500" src="Images/ICG_tb.png" alt="Integrated Clock Gating Testbench"> 
	<h5 align="center">Figure 5: Integrated Clock Gating Testbench</h5>
	<img width="1500" src="Images/AND.png" alt="And gate schematic"> 
	<h5 align="center">Figure 6: AND gate schematic</h5>
	<img width="1500" src="Images/Inverter.png" alt="Inverter schematic"> 
	<h5 align="center">Figure 7: Inverter schematic</h5>
	<img width="1500" src="Images/TG.png" alt="Transmission gate schematic"> 
	<h5 align="center">Figure 8: Transmission gate schematic</h5>
	</p>

## Schematic Netlist

The final netlist is as follows: 

```
*  Generated for: PrimeSim
*  Design library name: ICG_28nm
*  Design cell name: ICG_tb
*  Design view name: schematic
.lib 'saed32nm.lib' TT

*Custom Compiler Version S-2021.09
*Sun Feb 20 02:10:22 2022

.global gnd!
********************************************************************************
* Library          : ICG_28nm
* Cell             : INV
* View             : schematic
* View Search List : hspice hspiceD schematic spice veriloga
* View Stop List   : hspice hspiceD
********************************************************************************
.subckt inv a vdd vss y
xm0 y a vdd vdd p105 w=0.24u l=0.03u nf=1 m=1
xm1 y a vss vss n105 w=0.12u l=0.03u nf=1 m=1
.ends inv

********************************************************************************
* Library          : ICG_28nm
* Cell             : TG
* View             : schematic
* View Search List : hspice hspiceD schematic spice veriloga
* View Stop List   : hspice hspiceD
********************************************************************************
.subckt tg a b bbar y
xm2 a bbar y a p105 w=0.24u l=0.03u nf=1 m=1
xm1 a b y a n105 w=0.12u l=0.03u nf=1 m=1
.ends tg

********************************************************************************
* Library          : ICG_28nm
* Cell             : AND
* View             : schematic
* View Search List : hspice hspiceD schematic spice veriloga
* View Stop List   : hspice hspiceD
********************************************************************************
.subckt and a b out vdd vss
xm1 net17 b vdd vdd p105 w=0.24u l=0.03u nf=1 m=1
xm0 net17 a vdd vdd p105 w=0.24u l=0.03u nf=1 m=1
xm4 net17 a net19 net19 n105 w=0.12u l=0.03u nf=1 m=1
xm5 net19 b vss vss n105 w=0.12u l=0.03u nf=1 m=1
xi6 net17 vdd vss out inv
.ends and

********************************************************************************
* Library          : ICG_28nm
* Cell             : ICG
* View             : schematic
* View Search List : hspice hspiceD schematic spice veriloga
* View Stop List   : hspice hspiceD
********************************************************************************
.subckt icg clk enable icg_clk vdd vss
xi6 clk vdd vss net20 inv
xi2 net24 vdd vss net19 inv
xi1 net13 vdd vss net24 inv
xi0 enable vdd vss net16 inv
xi4 net19 clk net20 net13 tg
xi3 net16 net20 clk net13 tg
xi5 net24 clk icg_clk vdd vss and
.ends icg

********************************************************************************
* Library          : ICG_28nm
* Cell             : ICG_tb
* View             : schematic
* View Search List : hspice hspiceD schematic spice veriloga
* View Stop List   : hspice hspiceD
********************************************************************************
xi0 clk enable icg_out net6 gnd! icg
v2 net6 gnd! dc=0.9
v4 enable gnd! dc=0 pulse ( 0 0.9 18n 5n 5n 100n 300n )
v3 clk gnd! dc=0 pulse ( 0 0.9 2n 20p 20p 25n 51n )
c5 icg_out gnd! c=0.01f

.tran '50n' '500n' name=tran

.option primesim_remove_probe_prefix = 0
.probe v(*) i(*) level=1
.probe tran v(clk) v(enable) v(icg_out)

.temp 25

.option primesim_output=wdf

.option parhier = LOCAL

.end
```

- Netlist is generated by using Custom Compiler.


## Simulation result

- Custom Compiler Waveform

<p align="center">
	<img width="1100" src="https://user-images.githubusercontent.com/20799294/155723745-067eacce-52c3-46be-9a14-50ca24175b74.png" alt="refference ICG Trans"> 
	<h5 align="center">Figure 9: Experimental LDO output voltage as function of the load current.</h5>
</p>.

<p align="center">
	<img width="1100" src="https://user-images.githubusercontent.com/20799294/155725336-9aa2fcb6-fbb9-4bb6-ba8b-7799c032ef16.png" alt="refference ICG Trans"> 
	<h5 align="center">Figure 10: LDO output voltage and load current over the Parametric sweep of Rload .</h5>
</p>.

<p align="center">
	<img width="1100" src="https://user-images.githubusercontent.com/20799294/155725493-37c0a2ce-a8d5-42ca-a4e3-6ffea36d46fd.png" alt="refference ICG Trans"> 
	<h5 align="center">Figure 10: Tabulated values of LDO output voltage and load current over the Parametric sweep of Rload .</h5>
</p>.

<p align="center">
	<img width="1100" src="https://user-images.githubusercontent.com/20799294/155724585-b6b5b6a6-4c77-4599-bd81-6c255663d1b9.png" alt="refference ICG Trans"> 
	<h5 align="center">Figure 11: Load regulation characteristics of the LDO regulator as output current is varied from 1 to 40 mA with improved compensation.</h5>
</p>.

<p align="center">
	<img width="1100" src="https://user-images.githubusercontent.com/20799294/155724285-fbf29eee-ad57-4b43-b154-0b3219819333.png" alt="refference ICG Trans"> 
	<h5 align="center">Figure 12: Load regulation characteristics of the LDO regulator as output current is varied from 1 to 40 mA without improved compensation.</h5>
</p>.


![LDO_ipulse_w_freq]()


## Challenge
- The real challange is to adjust W/L ratio of pMos and nMos such that both have approximately equal rise and fall time.

## Troubleshooting
- After a lot of Trail and error found the W/L values of pMOS and nMOS such that both have approximately equal rise and fall time.

## Limitations
- Unnecessary using ICG's on design may increase overall area of the chip, So we have apply to flops having common enable signal which are more than bit width value.

## References

- [Synopsys solvnet documentation ](https://spdocs.synopsys.com/dow_retrieve/latest/dg/dcolh/Content/pwcug/pdf/pwcug.pdf)

- [A Novel Glitch-Free Integrated Clock Gating Cell for High Reliability - Emre Salman](https://www.researchgate.net/publication/332810977_A_Novel_Glitch-Free_Integrated_Clock_Gating_Cell_for_High_Reliability)

- [Signoff Semi blog](http://www.signoffsemi.com/synthesis/)

## Acknowledgements

- [Kunal Ghosh](https://github.com/kunalg123), Founder, VSD Corp. Pvt. Ltd
- [Indian Institute Of Technology (IIT), Hyderabad](https://iith.ac.in/)
- [Synopsys](https://www.synopsys.com/)

## Author

[Dinesh Patnaik](https://github.com/dineshp999),Bachelor of Technology in Electronics and Communication Engineering
